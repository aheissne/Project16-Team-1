<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scaffwording - Word Quiz</title>
  <style>
    body { font-family: Arial; margin:0; padding:0; background:#4a4a4a;
           display:flex; justify-content:center; align-items:center; height:100vh; }
    .quiz-container { background:#fff; padding:20px; border-radius:16px; text-align:center;
                      width:min(560px,92vw); box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .progress { color:#1a73e8; font-weight:600; margin-bottom:16px; font-size:20px; }
    .word { color:#1a73e8; font-size:64px; margin:14px 0 26px; }
    .buttons { display:flex; gap:14px; justify-content:center; }
    button { padding:14px 18px; border-radius:12px; width:46%; border:none; color:#fff;
             font-size:22px; cursor:pointer; transition:.2s; }
    .know { background:#34a853; } .know:hover{ background:#2c8d46; }
    .dont-know { background:#ea4335; } .dont-know:hover{ background:#c33428; }
    /* === Beautiful XP Bar === */
        .xp-progress{
            height:10px;
            background:#e0e0e0;
            border-radius:6px;
            overflow:hidden;
            margin-top:2px;
            box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .xp-fill{
            height:100%;
            background:linear-gradient(to right,#34a853,#5dd46c);
            width:0%;
            border-radius:6px;
            transition:width 0.8s ease-out;
            box-shadow:0 2px 4px rgba(52,168,83,0.3);
        }
  </style>
</head>
<body>
  <div class="quiz-container">
    <div class="xp-bar" id="xpDisplay" style="margin: 20px 0; font-weight: bold; color: #1a73e8; display: inline-block;">
        Loading XP...
        </div>
    <div id="progress" class="progress">Word 1 of 5</div>
    <div id="word" class="word">Loading…</div>
    <div class="buttons">
      <button id="knowBtn" class="know" type="button">Know</button>
      <button id="dontKnowBtn" class="dont-know" type="button">Don't Know</button>
    </div>
  </div>

  <script>
    // Hard-reload if page is restored from the back/forward cache
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) location.reload();
    });

    // Fisher–Yates shuffle
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const WORDS = await fetch('words.json').then(r => r.json()).catch(() => ({}));
      const allIds = Object.keys(WORDS).map(Number).filter(Number.isFinite).sort((a,b)=>a-b);

      let selectedIds = JSON.parse(localStorage.getItem('selectedWordIds') || '[]');
      const requested = Number(localStorage.getItem('maxQuestions')) ||
                        (Array.isArray(selectedIds) ? selectedIds.length : 0) || 5;

      // Normalize selection
      if (!Array.isArray(selectedIds) || !selectedIds.length) {
        selectedIds = allIds.slice(0, requested);
      } else if (selectedIds.length < requested) {
        const need = requested - selectedIds.length;
        const extras = allIds.filter(id => !selectedIds.includes(id)).slice(0, need);
        selectedIds = [...selectedIds, ...extras];
      } else if (selectedIds.length > requested) {
        selectedIds = selectedIds.slice(0, requested);
      }
      localStorage.setItem('selectedWordIds', JSON.stringify(selectedIds));

      let currentIndex = parseInt(new URLSearchParams(location.search).get('index')) || 0;

      // Fresh shuffle each new run
     if (currentIndex === 0) {
  localStorage.removeItem('shuffledWordIds');
  localStorage.setItem('quizScore', '0');
  localStorage.setItem('incorrectWords', JSON.stringify([]));
  localStorage.setItem('learnedWords', JSON.stringify([])); // ← add this
}


      let wordOrder = JSON.parse(localStorage.getItem('shuffledWordIds') || 'null');
      if (!Array.isArray(wordOrder) || wordOrder.length !== selectedIds.length) {
        wordOrder = shuffle(selectedIds);
        localStorage.setItem('shuffledWordIds', JSON.stringify(wordOrder));
      }

      const total = Math.min(requested, wordOrder.length);
      if (currentIndex >= total) {
        location.replace('learn-quiz-complete.html');
        return;
      }

      const wordId = wordOrder[currentIndex];
      const entry = WORDS[String(wordId)] || {};
      const word = entry.word || `Word ${wordId}`;

      document.getElementById('word').textContent = word;
      document.getElementById('progress').textContent = `Word ${currentIndex + 1} out of ${total}`;

      const nextIndex = currentIndex + 1;
      const $know = document.getElementById('knowBtn');
      const $dont = document.getElementById('dontKnowBtn');

      // Use JS navigation (no anchor defaults) to avoid partial restores
      $know.addEventListener('click', () => {
        const score = parseInt(localStorage.getItem('quizScore')) || 0;
        localStorage.setItem('quizScore', String(score + 1));
          // ✅ add to learned words
        const learned = new Set(JSON.parse(localStorage.getItem('learnedWords') || '[]'));
        learned.add(word); // 'word' is defined earlier from the selected entry
        localStorage.setItem('learnedWords', JSON.stringify([...learned]));
        addXP(10);

        if (nextIndex >= total) {
          location.replace('learn-quiz-complete.html');
        } else {
          location.replace(`learn-quiz.html?index=${nextIndex}`);
        }
      });

      $dont.addEventListener('click', () => {
        // same word, switch to meaning view
        location.replace(`learn-meaning.html?index=${currentIndex}`);
      });
    });
  </script>
  <script src="xp.js"></script>
  <script>
window.addEventListener('load', () => {
    const xpContainer = document.getElementById('xpDisplay');

    // 1. Let xp.js write the level + XP text
    renderXP('xpDisplay');

    // 2. Now inject the beautiful progress bar (it won't be overwritten anymore)
    if (!document.querySelector('.xp-progress')) {
        xpContainer.insertAdjacentHTML('beforeend', `
            <div class="xp-progress">
                <div class="xp-fill"></div>
            </div>
        `);
    }

    // 3. Finally fill the green bar
    if (typeof getXP === 'function' && typeof XP_PER_LEVEL === 'number') {
        const progress = (getXP() % XP_PER_LEVEL) / XP_PER_LEVEL * 100;
        const fill = document.querySelector('.xp-fill');
        if (fill) fill.style.width = progress + '%';
    }
});
</script>
</body>
</html>
